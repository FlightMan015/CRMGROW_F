<div class="page-content">
  <div class="automation-container">
    <form #automationForm="ngForm" (ngSubmit)="submitted=true; automationForm.form.valid ? storeData() : false;"
      [class.was-validated]="submitted" class="mb-4">
      <div class="v-center op-56 c-pointer mb-3 back-menu" (click)="goToBack()">
        <i class="d-block i-icon i-triangle-left bgc-dark mr-2 sm"></i>
        <span class="f-5 font-weight-bold">Back {{getPrevPage()}}</span>
      </div>
      <div class="align-items-top automation-name-wrapper">
        <div class="row align-items-center">
          <div class="col-md-6 col-sm-12 col-12">
            <div class="form-group d-flex align-items-end">
              <div class="title w-100">
                <div class="v-center justify-content-between">
                  <label for="automation-title" class="title">Title</label>
                  <span class="error f-3 font-weight-bold" *ngIf="automation_title == '' && submitted">
                    Required!
                  </span>
                </div>
                <input class="form-control"
                   id="automation-title"
                   [(ngModel)]="automation_title" type="text"
                   name="automationTitle"
                   #automationTitle="ngModel"
                   placeholder="Type in new automation title"
                   required
                >

              </div>
              <div class="btn-wrapper ml-2" [class.disable]="!isPackageAutomation" [class.disabled]="loadingAutomation" *ngIf="editMode === 'new' || owner_id === user_id">
                <button class="btn btn-primary br-default" [class.loading]="isSaving" type="submit">
                  {{this.editMode ? 'Save' : 'Create'}}
                </button>
              </div>
            </div>
          </div>
          <div class="col-md-3 col-sm-6 col-12">
            <div class="d-flex">
              <div>
                <div><label class="title">Type</label></div>
                <div class="form-group d-flex">
                  <div class="custom-radio-container mt-2" [class.disabled]="automation && automation._id">
                    <input class="custom-radio" type="radio" id="template-type-email" name="template-type"
                      [checked]="automation_type == 'contact'" (click)="changeType($event,'contact')">
                    <label class="f-6 font-weight-bold" for="template-type-email">Contact</label>
                  </div>
                  <div class="custom-radio-container mt-2" [class.disabled]="automation && automation._id"
                    style="margin-left: 60px;">
                    <input class="custom-radio" type="radio" id="template-type-text" name="template-type"
                      [checked]="automation_type === 'deal'" (click)="changeType($event,'deal')">
                    <label class="f-6 font-weight-bold ml-2" for="template-type-text">Deal</label>
                  </div>
                </div>
              </div>
              <div class="custom" [class.disabled]="automation && automation._id" style="margin-left: 60px;">
                <div><label class="title">Label</label></div>
                <ng-container *ngIf="editMode=='new';else editTemplate">
                  <select id="types" class="form-control theme-control" [(ngModel)]="label" name="automation" (change)="onChange($event.target.value)"
                    #automation="ngModel" style="width: fit-content;">
                    <option *ngFor="let type of TYPES" value="{{type.id}}">{{type.label}}</option>
                  </select>
                </ng-container>
                <ng-template #editTemplate>
                  <select id="types" class="form-control theme-control" [(ngModel)]="label" name="automation" (change)="onChange($event.target.value)"
                    #automation="ngModel" style="width: fit-content;">
                    <option *ngFor="let type of TYPES" value="{{type.id}}">{{type.label}}</option>
                  </select>
                </ng-template>
              </div>
            </div>
          </div>
          <div class="col-md-2 col-sm-4 col-6">
            <div class="form-group v-center justify-content-end">
              <div class="created ml-4 mt-4" align="end"
                *ngIf="automation && editMode == 'edit' && owner_id && user_id && owner_id!== user_id">
                <div class="v-center btn p-1 c-dark" (click)="download(automation)" placement="bottom"
                  ngbTooltip="Download to own list">
                  <button type="button" class="btn btn-primary shadow">
                  <span class="font-weight-bold f-3">Download</span>
                </button>
              </div>
              </div>
            </div>
          </div>
          <div class="col-md-1 col-sm-4 col-6 mt-3" *ngIf="automation && editMode == 'edit'&& owner_id === user_id">
            <div class="v-center justify-content-end">
              <button type="button" class="btn btn-primary shadow"
                (click)="assignContacts()"
                [class.disabled]="loadingAutomation"
              >
                <span class="font-weight-bold f-3">Assign</span>
              </button>
              <ng-container *ngIf="(auth == 'admin' || auth == 'shared'); else moreTemplate">
              </ng-container>
              <ng-template #moreTemplate>
                <div ngbDropdown class="d-flex p-2 button-more py-2 rounded" [class.disabled]="loadingAutomation">
                  <button type="button" class="v-center btn btn-white-blue py-2" ngbDropdownToggle>
                    <span class="font-weight-bold f-3 c-blue">More</span>
                  </button>
                  <div ngbDropdownMenu class="light">
                    <button type="button"
                      class="v-center border-0 py-2 c-dark dropdown-item"
                      [class.disable]="!isPackageAutomation"
                      (click)="duplicate($event, automation)"
                    >
                      <span class="f-3 font-weight-bold">Clone</span>
                    </button>
                    <button type="button" class="v-center border-0 py-2 c-dark dropdown-item"
                            (click)="shareAutomation($event, automation)"
                            *ngIf="automation.user == user_id"
                    >
                      <span class="f-3 font-weight-bold">Share team</span>
                    </button>
                    <hr class="my-1">
                    <button type="button"
                      class="v-center border-0 py-2 c-dark dropdown-item"
                      [class.disable]="!isPackageAutomation"
                      (click)="delete()"
                    >
                      <span class="c-red f-3 font-weight-bold">Delete automation</span>
                    </button>
                  </div>
                </div>
              </ng-template>
            </div>
          </div>
        </div>
      </div>
    </form>
    <ng-container *ngIf="loadingAutomation">
      <div class="loading-container text-center mt-5">
        <div class="loader mt-5 lg"></div>
        <h4 class="fw-600 mt-2">Loading actions and compose graph...</h4>
      </div>
    </ng-container>
    <ng-container *ngIf="isShowComplete()">
      <app-slide-tab [tabs]="tabs" [selected]="selectedTab" type="plain" (onChange)="changeTab($event)" class="border-bottom pl-0 rounded-0">
      </app-slide-tab>
      <div class="card-body activity" [class.d-none]="selectedTab.id !== 'activity'">
        <button class="d-none" (click)="clearAllNodes()">Clear</button>
        <!-- <div class="" draggable="true" (dragstart)="dragAction($event)">DRAG</div> -->
        <div class="flows-container" [class.full-screen]="isFullScreen" [class.mt-3]="!isFullScreen" #wrapper>
          <div class="zoom-button-wrapper">
            <button class="v-center justify-content-center btn btn-white font-weight-bold"
              [class.disabled]="zoomLevel <= 0.4 || !nodes.length"
              (click)="zoomOut()"
            >
              <i class="i-icon i-zoom-out"
                 [class.bgc-blue]="zoomLevel >= 0.4 && nodes.length"
                 [class.bgc-grey]="zoomLevel < 0.4 || !nodes.length"
              ></i>
            </button>
            <button class="v-center justify-content-center btn btn-white font-weight-bold"
              [class.disabled]="zoomLevel > 1.5 || !nodes.length"
              (click)="zoomIn()"
            >
              <i class="i-icon i-zoom-in"
                 [class.bgc-blue]="zoomLevel <= 1.5 && nodes.length"
                 [class.bgc-grey]="zoomLevel > 1.5 || !nodes.length"
              ></i>
            </button>
            <button class="v-center justify-content-center btn btn-white font-weight-bold"
                    (click)="fullScreen()"
            >
              <i class="bgc-blue i-icon i-full-screen"></i>
            </button>
          </div>
          <div class="count-container" *ngIf="automation">
            <div class="actions-count">
              <label class="f-1 text-uppercase">Actions</label>
              <div class="content actions">
                <p class="count font-weight-bold">{{automation && automation.automations && automation.automations.length ? automation.automations.length : 0}}</p>
              </div>
            </div>
            <div class="contacts-count mt-3" *ngIf="editMode == 'edit'">
              <label class="f-1 text-uppercase">Contacts</label>
              <div class="content contacts">
                <p class="count font-weight-bold">{{contacts || '0'}}</p>
              </div>
            </div>
          </div>
          <ng-container *ngIf="!nodes.length; else flowTemplate">
            <div class="init-graph-container">
              <ngx-graph class="chart-container init-container" [links]="initEdges" [nodes]="initNodes"
                         [layoutSettings]="layoutSettings" [layout]="layout" [curve]="curve" [draggingEnabled]="false"
                         [panningEnabled]="false" [view]="[300, 200]" [enableZoom]="false">
                <ng-template #nodeTemplate let-node>
                  <svg:g class="node">
                    <svg:rect [attr.width]="node.dimension.width" [attr.height]="node.dimension.height"
                              fill="transparent" />
                    <svg:foreignObject width="200" height="222">
                      <xhtml:div xmlns="http://www.w3.org/1999/xhtml" (click)="addAction()" (drop)="startDrop($event)"
                                 (dragover)="allowStartDrop($event, node)" (dragleave)="disableStartArea($event, node)"
                                 (dragenter)="enableStartArea($event, node)" [class.droppable]="node.droppable"
                                 class="drop-target">
                        <xhtml:div class="cardContainer c-pointer" style="margin-bottom: 5px; text-align: center;"
                                   xmlns="http://www.w3.org/1999/xhtml">
                          <img [attr.src]="'./assets/img/automations/automation_start.svg'" x="75" y="0" height="50px"
                               width="50px" />
                        </xhtml:div>
                        <xhtml:div class="cardContainer"
                                   style="background-color: transparent; padding: 5px 8px; text-align: center; width: 150px; margin-left: 25px; margin-right: 25px;"
                                   xmlns="http://www.w3.org/1999/xhtml">
                          <label class="name" style="margin: 0; font-size: 13px;">Start</label>
                          <label class="name" style="margin: 0; font-size: 10px; color: #aaa;">
                            DRAG'N'DROP ACTION OR CLICK HERE
                          </label>
                        </xhtml:div>
                      </xhtml:div>
                    </svg:foreignObject>
                  </svg:g>
                </ng-template>
              </ngx-graph>
            </div>
          </ng-container>

          <ng-template #flowTemplate>
            <ngx-graph class="chart-container" [links]="edges" [nodes]="nodes" [layoutSettings]="layoutSettings"
                       [autoCenter]="autoCenter" [panToNode$]="panToNode$" [layout]="layout" [curve]="curve" [center$]="center$" [draggingEnabled]="false"
                       [autoZoom]="autoZoom" [minZoomLevel]="0.4" [maxZoomLevel]="1.5" [zoomSpeed]="0.1" [zoomLevel]="zoomLevel" [animate]="true" [enableZoom]="true"
                       #graphWrapper>
              <ng-template #defsTemplate>
                <svg:marker id="arrow" viewBox="0 0 20 20" refX="20" refY="10" markerWidth="8" markerHeight="8"
                            orient="auto">
                  <circle cx="10" cy="10" r="10" stroke="green" stroke-width="0" fill="gray" />
                </svg:marker>
                <svg:pattern id="diagonalHatch" patternUnits="userSpaceOnUse" width="4" height="4">
                  <svg:path d="M-1,1 l2,-2
                       M0,4 l4,-4
                       M3,5 l2,-2" style="stroke:#eee; stroke-width:1" />
                </svg:pattern>
              </ng-template>

              <ng-template #nodeTemplate let-node>
                <svg:g class="node" *ngIf="node.category === 'START' && isShowStartAction()">
                  <svg:rect [attr.width]="node.dimension.width" height="90"
                            fill="transparent" />
                  <svg:foreignObject width="200" height="90">
                    <xhtml:div class="cardContainer c-pointer" (click)="addAction(node)"
                               #treeNode
                               style="text-align: center; position: initial; padding: 3px;"
                               xmlns="http://www.w3.org/1999/xhtml">
                      <img [attr.src]="'./assets/img/automations/automation_start.svg'" height="50px"
                           width="50px" />
                    </xhtml:div>
                    <xhtml:div class="cardContainer" (click)="addAction(node)"
                               style="background-color: transparent; padding: 5px 8px; text-align: center; width: 150px; margin-left: 25px; margin-right: 25px; margin-top: -10px"
                               xmlns="http://www.w3.org/1999/xhtml">
                      <label class="name" style="margin: 0; font-size: 13px; font-weight: bold">Start</label>
                    </xhtml:div>
                  </svg:foreignObject>
                </svg:g>
                <svg:g class="node" *ngIf="node.category === 'NORMAL'">
                  <svg:rect [attr.width]="node.dimension.width" [attr.height]="node.leaf ? 200 : (isShowTimeDelay(node) ? 110 : 90)"
                            fill="transparent" />
                  <svg:foreignObject width="200" [attr.height]="node.leaf ? 200 : (isShowTimeDelay(node) ? 110 : 90)">
                    <xhtml:div class="cardContainer c-pointer"
                               #treeNode
                               (click)="easyView($event, node, treeNode, treeOverlay)"
                               style="text-align: center; position: initial; padding: 3px;"
                               xmlns="http://www.w3.org/1999/xhtml">
                      <img [attr.src]="ICONS[node.type]" x="75" y="0" height="45px" width="45px" style="margin-top: 5px;"/>
                      <ng-container *ngIf="isLastAddedAction(node) && !isSafari">
                        <img class="last-added-action" src="../../../assets/img/automations/last_action.svg" width="55px" height="55px" />
                      </ng-container>
                    </xhtml:div>
                    <ng-container *ngIf="node.leaf; else leafNode">
                      <xhtml:div class="cardContainer"
                                 style="background-color: transparent; padding: 5px 8px 20px 8px; margin-bottom: 15px; text-align: center;"
                                 xmlns="http://www.w3.org/1999/xhtml">
                        <label class="name" style="margin: 0; font-size: 14px; font-weight: bold;">{{node.label}}</label>
                        <ng-container *ngIf="isShowTimeDelay(node)">
                          <label class="name" style="margin: 0; font-size: 11px; color: #f28422; display: block;">{{node.period | duration}}</label>
                        </ng-container>
                      </xhtml:div>
                    </ng-container>
                    <ng-template #leafNode>
                      <xhtml:div class="cardContainer"
                                 style="background-color: transparent; text-align: center;"
                                 xmlns="http://www.w3.org/1999/xhtml">
                        <label class="name" style="margin: 0; font-size: 14px; font-weight: bold;">{{node.label}}</label>
                        <ng-container *ngIf="isShowTimeDelay(node)">
                          <label class="name" style="margin: 0; font-size: 11px; color: #f28422; display: block;">{{node.period | duration}}</label>
                        </ng-container>
                        <ng-container *ngIf="hasMultipleBranch(node)">
                          <img src="../../../assets/img/automations/branch.png"
                               style="margin-top: -12px; transform: rotate(180deg); cursor: pointer;" height="20px" width="20px"
                               (click)="insertBranch(node)"
                          />
                        </ng-container>
                      </xhtml:div>
                    </ng-template>
                    <ng-container *ngIf="node.leaf">
                      <xhtml:div
                        style="background-color: transparent; border-left: 2px dashed #aaa; width: 2px; height: 30px; margin-top: -15px; margin-left: auto; margin-right: auto;"
                        xmlns="http://www.w3.org/1999/xhtml">
                      </xhtml:div>
                      <xhtml:div class="cardContainer c-pointer" (click)="addAction(node)"
                                 style="margin-bottom: 5px; margin-top: 5px; text-align: center; cursor: pointer"
                                 xmlns="http://www.w3.org/1999/xhtml">
                        <img [attr.src]="'./assets/img/automations/automation_start.svg'" x="75" y="0" height="42px"
                             width="42px" />
                      </xhtml:div>
                    </ng-container>
                  </svg:foreignObject>
                </svg:g>
                <svg:g class="node" *ngIf="node.category === 'CONDITION'">
                  <svg:rect [attr.width]="node.dimension.width" [attr.height]="40"
                            fill="transparent" />
                  <svg:foreignObject width="140" [attr.height]="40" style="overflow: visible">
                    <xhtml:div [class.trueCase]="node.condition.answer" [class.falseCase]="!node.condition.answer"
                               xmlns="http://www.w3.org/1999/xhtml">
                      <label class="name" style="margin: 0; font-size: 12px; font-weight: bold;">{{node.label}}</label>
                    </xhtml:div>
                    <ng-container *ngIf="node.leaf">
                      <xhtml:div
                        style="background-color: transparent; border-left: 2px dashed #aaa; width: 2px; height: 30px; margin-top: -15px; margin-left: auto; margin-right: auto;"
                        xmlns="http://www.w3.org/1999/xhtml">
                      </xhtml:div>
                      <xhtml:div class="cardContainer c-pointer" (click)="addAction(node)"
                                 style="margin-bottom: 5px; margin-top: 5px; text-align: center;"
                                 xmlns="http://www.w3.org/1999/xhtml">
                        <img [attr.src]="'./assets/img/automations/automation_start.svg'" x="75" y="0" height="42px"
                             width="42px" />
                      </xhtml:div>
                    </ng-container>
                  </svg:foreignObject>
                </svg:g>
              </ng-template>
              <ng-template #linkTemplate let-link>
                <svg:g class="edge">
                  <svg:path class="line" stroke="#aaa" stroke-width="1" marker-start="url(#arrow)">
                  </svg:path>
                </svg:g>
                <svg:g class="linkMidpoint" *ngIf="link.midPoint && !link.category"
                       [attr.transform]="'translate(' + (link.midPoint.x) + ',' + (link.midPoint.y) + ')'"
                       (click)="insertAction(link)">
                  <ng-container *ngIf="isLastClickedLink(link); else normalLink">
                    <svg:foreignObject width="20" height="20" x="-10" y="-10">
                      <xhtml:div xmlns="http://www.w3.org/1999/xhtml" style="height: 20px; text-align: center; position: relative;">
                        <label style="margin: 0; font-size: 24px; line-height: 18px; cursor: pointer; color: #0000ff">+</label>
                        <img class="last-added-action" src="../../../assets/img/automations/last_link.png" width="20px" height="20px"/>
                      </xhtml:div>
                    </svg:foreignObject>
                  </ng-container>
                  <ng-template #normalLink>
                    <ellipse rx="10" ry="10" fill='white' stroke='black' strokeWidth='2' />
                    <svg:foreignObject width="20" height="20" x="-10" y="-10">
                      <xhtml:div xmlns="http://www.w3.org/1999/xhtml" style="height: 20px; text-align: center; position: relative;">
                        <label style="margin: 0; font-size: 24px; line-height: 18px; cursor: pointer;">+</label>
                      </xhtml:div>
                    </svg:foreignObject>
                  </ng-template>
                </svg:g>
                <svg:g class="label" *ngIf="link.hasLabel && link.points && link.points[0]" [attr.transform]="'translate(' + (link.points[0].x - 40) + ',' + (link.points[0].y + 40) + ')'">
                  <svg:rect [attr.width]="90" [attr.height]="60"
                            fill="transparent" />
                  <svg:foreignObject width="90" [attr.height]="120">
                    <xhtml:div class="caseLabel"
                               style="position: initial; background-color: transparent; text-align: center;"
                               xmlns="http://www.w3.org/1999/xhtml">
                      <div class='link' (click)="editNode(link)">
                        <label class="name" style="margin-top: 20px; margin-bottom: 0px; font-size: 14px;">{{CASE_ACTIONS[link.data && link.data.type ? link.data.type : link.type]}}</label>
                        <label class="name percent"
                         *ngIf="link.data?.percent && (link.data?.type=='watched_material' || link.type == 'watched_material')">
                          {{link.data?.percent}}%
                        </label>
                      </div>
                      <label class="remove-link" (click)="removeCase(link)">&times;</label>
                    </xhtml:div>
                  </svg:foreignObject>
                </svg:g>
              </ng-template>
            </ngx-graph>
          </ng-template>
          <ng-template #treeOverlay let-close="close" let-data>
            <app-automation-detail-overlay
              [fullDataSource]="data.data"
              [type]="'edit'"
              [automationType]="automation_type"
              [class]="data.data && data.data.type != 'automation' ? 'side' : ''"
            >
            </app-automation-detail-overlay>
          </ng-template>
        </div>
      </div>
      <div class="card-body contact mt-2" *ngIf="selectedTab.id == 'contacts'">
        <div class="form-group mt-3 mb-0 search-form">
          <div class="input-group-prepend">
            <i class="i-icon i-search d-block bgc-dark"></i>
          </div>
          <input type="text" class="form-control" placeholder="Search" aria-label="search" aria-describedby="search-addon" [(ngModel)]="searchStr" (ngModelChange)="changeSearchStr()">
          <ng-container *ngIf="searchStr">
            <div class="cancel-action c-pointer" (click)="clearSearchStr()">
              <i class="i-icon i-close d-block bgc-dark"></i>
            </div>
          </ng-container>
        </div>
        <div class="custom-mat-table position-relative mt-3">
          <div class="mat-table-wrapper mode-2">
            <table class="w-100 page-table"
                   mat-table
                   [dataSource]="pageContacts | paginate: {id: 'contactPages', itemsPerPage: pageSize.id, currentPage: page, totalItems: contacts}">

              <ng-container matColumnDef="loader-cell">
                <th mat-header-cell
                    *matHeaderCellDef colspan="12" class="loader-cell">
                  <div class="updating-status"
                       *ngIf="pageContacts.length && assignedContactLoading">
                    LOADING
                  </div>
                </th>
              </ng-container>

              <ng-container matColumnDef="select">
                <th mat-header-cell
                    *matHeaderCellDef
                    class="pl-2">
                  <div class="custom-control custom-checkbox"
                       [class.indeterminate]="pageContacts.length && !isAllSelected()">
                    <input type="checkbox"
                           class="custom-control-input"
                           id="selectAllContacts"
                           (change)="$event ? masterToggle() : null"
                           [checked]="pageContacts.length && isAllSelected()" />
                    <label class="custom-control-label"
                           for="selectAllContacts"></label>
                  </div>
                </th>
                <td mat-cell
                    *matCellDef="let element"
                    class="pl-2">
                  <div class="custom-control custom-checkbox">
                    <input type="checkbox"
                           class="custom-control-input"
                           id="contact-{{element._id}}"
                           (change)="toggle(element)"
                           [checked]="isSelected(element)" />
                    <label class="custom-control-label"
                           for="contact-{{element._id}}"></label>
                  </div>
                </td>
              </ng-container>

              <!-- Name Column -->
              <ng-container matColumnDef="contact_name">
                <ng-container *matHeaderCellDef>
                  <th mat-header-cell
                      *ngIf="!selection.length; else toolHeader"> contact name </th>
                  <ng-template #toolHeader>
                    <th mat-header-cell colspan="7">
                      <div class="v-center">
                        <span class="c-dark f-3 text-lowercase font-weight-bold">{{selection.length}} selected</span>
                        <app-actions-header [actions]="CONTACT_ACTIONS" [disableActions]="disableActions" (doCommand)="doAction($event)"></app-actions-header>
                      </div>
                    </th>
                  </ng-template>
                </ng-container>
                <td mat-cell
                    *matCellDef="let element"
                    (click)="openContact(element)">
                  <div class="v-center c-pointer">
                    <div class="contact-avatar f-3 mr-2">{{element.avatarName}}</div>
                    <span class="fw-600">{{element.fullName}}</span>
                  </div>
                </td>
              </ng-container>

              <!-- Label Column -->
              <ng-container matColumnDef="contact_label">
                <ng-container *matHeaderCellDef>
                  <th mat-header-cell
                      *ngIf="!selection.length">label</th>
                </ng-container>
                <td mat-cell
                    *matCellDef="let element">
                  <app-label-select [value]="element.label" (valueChange)="updateLabel($event, element._id)"></app-label-select>
                </td>
              </ng-container>

              <!-- Tags Column -->
              <ng-container matColumnDef="contact_tags">
                <ng-container *matHeaderCellDef>
                  <th mat-header-cell
                      *ngIf="!selection.length"> tags </th>
                </ng-container>
                <td mat-cell
                    *matCellDef="let element"
                    (click)="openContact(element)">
                <span class="tag rounded mr-2"
                      *ngIf="element.tags.length">{{element.tags[0]}}</span>
                  <span class="f-2 op-56">{{element.moreTag}}</span>
                </td>
              </ng-container>

              <!-- Email Column -->
              <ng-container matColumnDef="contact_email">
                <ng-container *matHeaderCellDef>
                  <th mat-header-cell
                      *ngIf="!selection.length"> email address  </th>
                </ng-container>
                <td mat-cell
                    *matCellDef="let element"
                    (click)="openContact(element)">
                  <span class="">{{element.email}}</span>
                </td>
              </ng-container>

              <!-- Phone Column -->
              <ng-container matColumnDef="contact_phone">
                <ng-container *matHeaderCellDef>
                  <th mat-header-cell
                      *ngIf="!selection.length"> phone number </th>
                </ng-container>
                <td mat-cell
                    *matCellDef="let element"
                    (click)="openContact(element)">
                  <span class="c-blue font-weight-bold">{{element.cell_phone | phone_format}}</span>
                </td>
              </ng-container>

              <ng-container matColumnDef="contact_address">
                <ng-container *matHeaderCellDef>
                  <th mat-header-cell class="address-col" *ngIf="!selection.length">Address</th>
                </ng-container>
                <td mat-cell
                    *matCellDef="let element" class="address-col">
                  <a class="c-pointer undecoration c-dark d-block" [routerLink]="['/contacts/' + element._id]">
                    <span class="c-dark">{{element.shortAddress}}</span>
                  </a>
                </td>
              </ng-container>

              <ng-container matColumnDef="selection_info">
                <th mat-header-cell *matHeaderCellDef colspan="8" class="text-center">
                <span *ngIf="selection.length !== contacts; else deselectTemplate">
                  {{selection.length}} contacts are selected.
                  <span  class="c-blue font-weight-bold" *ngIf="selecting && selectSource === 'page'">
                    <i class="small-spinner"></i>
                    <span class="ml-1">Selecting all. . .</span>
                  </span>
                  <span class="c-blue font-weight-bold c-pointer" *ngIf="!selecting" (click)="selectAll()">
                    Select all {{contacts}} contacts
                  </span>
                </span>
                  <ng-template #deselectTemplate>
                    All {{contacts}} contacts are selected. <span class="c-blue c-pointer font-weight-bold" (click)="deselectAll()">Clear selection</span>
                  </ng-template>
                </th>
              </ng-container>

              <tr mat-header-row
                  *matHeaderRowDef="['loader-cell']" class="loader-row"></tr>
              <tr mat-header-row
                  *matHeaderRowDef="DISPLAY_COLUMNS" [class.selected]="selection.length" class="table-header"></tr>
              <tr mat-header-row *matHeaderRowDef="['selection_info']" [class.d-none]="!selection.length" class='selection-info'></tr>
              <tr mat-row
                  *matRowDef="let row; columns: DISPLAY_COLUMNS;"></tr>
            </table>
          </div>
          <ng-container *ngIf="pageContacts.length; else emptyListTemplate">
            <div class="table-control mode-1">
              <div class="pagination-wrapper m-auto">
                <pagination-controls (pageChange)="changePage($event)"
                                     (pageBoundsCorrection)="pageChanged($event)"
                                     id="contactPages"
                                     maxSize="5"
                                     previousLabel=""
                                     nextLabel="">
                </pagination-controls>
              </div>
              <div class="shadow-dropdown ml-auto page-size-control"
                   ngbDropdown
                   placement="top-right">
                <div class="v-center c-pointer f-3 p-3 font-weight-bold"
                     ngbDropdownToggle>
                  <span class="pr-2 c-blue">Show {{pageSize.id}} rows per page</span>
                </div>
                <div ngbDropdownMenu
                     aria-labelledby="contactPageSize">
                  <div class="py-2"
                       ngbDropdownItem
                       *ngFor="let type of PAGE_COUNTS"
                       (click)="changePageSize(type)">
                  <span class="f-3 v-center"
                        [class.font-weight-bold]="type.id === pageSize.id">
                    Show {{type.label}} rows per page
                    <i class="i-icon i-check d-block bgc-blue sm ml-1 mb-1"
                       *ngIf="type.id === pageSize.id"></i>
                  </span>
                  </div>
                </div>
              </div>
            </div>
          </ng-container>
          <ng-template #emptyListTemplate>
            <ng-container>
              <div class="empty-list py-5" *ngIf="!assignedContactLoading">
                <div class="object-icon v-center">
                  <i class="i-icon i-lunch d-block bgc-dark"></i>
                </div>
                <h4 class="font-weight-bold mt-4 mb-3">
                  There is no assigned contacts.
                </h4>
              </div>
              <div class="list-loading text-center" *ngIf="assignedContactLoading">
                <div class="loader mt-5 lg"></div>
                <h4 class="fw-600 mt-2">Loading assigned contacts in this automation...</h4>
              </div>
            </ng-container>
          </ng-template>
        </div>
      </div>
      <div class="card-body contact mt-2" *ngIf="selectedTab.id == 'deals'">
        <div class="form-group mt-3 mb-0 search-form">
          <div class="input-group-prepend">
            <i class="i-icon i-search d-block bgc-dark"></i>
          </div>
          <input type="text" class="form-control" placeholder="Search" aria-label="search" aria-describedby="search-addon" [(ngModel)]="searchStr" (ngModelChange)="changeSearchStr()">
          <ng-container *ngIf="searchStr">
            <div class="cancel-action c-pointer" (click)="clearSearchStr()">
              <i class="i-icon i-close d-block bgc-dark"></i>
            </div>
          </ng-container>
        </div>
        <div class="custom-mat-table position-relative mt-3">
          <div class="mat-table-wrapper mode-2">
            <table class="w-100 page-table"
                   mat-table
                   [dataSource]="pageDeals | paginate: {id: 'dealPages', itemsPerPage: pageSize.id, currentPage: page, totalItems: totalDeals}">

              <ng-container matColumnDef="loader-cell">
                <th mat-header-cell
                    *matHeaderCellDef colspan="12" class="loader-cell">
                  <div class="updating-status"
                       *ngIf="pageDeals.length && loadingDeals">
                    LOADING
                  </div>
                </th>
              </ng-container>

              <!-- Title Column -->
              <ng-container matColumnDef="deal_title">
                <th mat-header-cell *matHeaderCellDef class="deal-title"> Title </th>
                <td mat-cell
                    *matCellDef="let element"
                    (click)="openDeal(element.deal)"
                    class="deal-title"
                >
                  <div class="v-center c-pointer">
                    <div class="f-3 mr-2">{{element.deal.title}}</div>
                  </div>
                </td>
              </ng-container>

              <!-- Deal Stage Column -->
              <ng-container matColumnDef="deal_stage">
                <th mat-header-cell *matHeaderCellDef>Stage</th>
                <td mat-cell
                    *matCellDef="let element"
                    (click)="openDeal(element.deal)"
                >
                  <div class="v-center c-pointer">
                    <div class="f-3 mr-2">{{element.deal.deal_stage ? element.deal.deal_stage['title'] : ''}}</div>
                  </div>
                </td>
              </ng-container>

              <!-- Contacts Column -->
              <ng-container matColumnDef="deal_contacts">
                <th mat-header-cell *matHeaderCellDef> Contacts </th>
                <td mat-cell *matCellDef="let element">
                  <div class="v-center ml-3" *ngIf="element.contacts && element.contacts.length > 0">
                    <div class="v-center">
                      <div class="d-flex align-items-start flex-wrap">
                        <div class="related-contact" *ngFor="let contact of element.contacts.slice(0, 5)">
                          <div class="contact" ngbDropdown>
                            <div class="avatar bd bgc-dark text-white f-2 text-center rounded-circle c-pointer" ngbDropdownToggle>
                              {{contact.avatarName}}
                            </div>
                            <div ngbDropdownMenu class="contact-list light px-2">
                              <div class="v-center">
                                <div class="avatar bd bgc-dark text-white f-2 text-center rounded-circle">{{contact.avatarName}}</div>
                                <div class="ml-2">
                                  <div class="f-2 font-weight-bold name">{{contact.fullName}}</div>
                                  <div class="f-1">{{contact.email}}</div>
                                  <div class="f-1">{{contact.cell_phone}}</div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                        <ng-container *ngIf="element.contacts.length > 5">
                          <div class="contact related-contact" ngbDropdown>
                            <div class="avatar bd bgc-dark text-white f-2 text-center rounded-circle c-pointer" ngbDropdownToggle>
                              +{{element.contacts.length - 5}}
                            </div>
                            <div ngbDropdownMenu class="contact-list light px-2">
                              <div class="v-center" *ngFor="let contact of element.contacts.slice(5, element.contacts.length)">
                                <div class="avatar bd bgc-dark text-white f-2 text-center rounded-circle">{{contact.avatarName}}</div>
                                <div class="ml-2">
                                  <div class="f-2 font-weight-bold name">{{contact.fullName}}</div>
                                  <div class="f-1">{{contact.email}}</div>
                                  <div class="f-1">{{contact.cell_phone}}</div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </ng-container>
                      </div>
                    </div>
                  </div>
                </td>
              </ng-container>

              <tr mat-header-row
                  *matHeaderRowDef="['loader-cell']" class="loader-row"></tr>
              <tr mat-header-row
                  *matHeaderRowDef="DEAL_DISPLAY_COLUMNS" class="table-header"></tr>
              <tr mat-row
                  *matRowDef="let row; columns: DEAL_DISPLAY_COLUMNS;"></tr>
            </table>
          </div>
          <ng-container *ngIf="pageDeals.length; else emptyListTemplate">
            <div class="table-control mode-1">
              <div class="pagination-wrapper m-auto">
                <pagination-controls (pageChange)="changeDealPage($event)"
                                     (pageBoundsCorrection)="pageDealChanged($event)"
                                     id="dealPages"
                                     maxSize="5"
                                     previousLabel=""
                                     nextLabel="">
                </pagination-controls>
              </div>
              <div class="shadow-dropdown ml-auto page-size-control"
                   ngbDropdown
                   placement="top-right">
                <div class="v-center c-pointer f-3 p-3 font-weight-bold"
                     ngbDropdownToggle>
                  <span class="pr-2 c-blue">Show {{pageSize.id}} rows per page</span>
                </div>
                <div ngbDropdownMenu
                     aria-labelledby="contactPageSize">
                  <div class="py-2"
                       ngbDropdownItem
                       *ngFor="let type of PAGE_COUNTS"
                       (click)="changePageSize(type)">
                  <span class="f-3 v-center"
                        [class.font-weight-bold]="type.id === pageSize.id">
                    Show {{type.label}} rows per page
                    <i class="i-icon i-check d-block bgc-blue sm ml-1 mb-1"
                       *ngIf="type.id === pageSize.id"></i>
                  </span>
                  </div>
                </div>
              </div>
            </div>
          </ng-container>
          <ng-template #emptyListTemplate>
            <ng-container>
              <div class="empty-list py-5" *ngIf="!loadingDeals">
                <div class="object-icon v-center">
                  <i class="i-icon i-lunch d-block bgc-dark"></i>
                </div>
                <h4 class="font-weight-bold mt-4 mb-3">
                  There is no assigned deals.
                </h4>
              </div>
              <div class="list-loading text-center" *ngIf="loadingDeals">
                <div class="loader mt-5 lg"></div>
                <h4 class="fw-600 mt-2">Loading assigned deals in this automation...</h4>
              </div>
            </ng-container>
          </ng-template>
        </div>
      </div>
    </ng-container>

  </div>
</div>

<mat-drawer-container [hasBackdrop]="true" [class]="'automation'">
  <mat-drawer #addDrawer position="end" [disableClose]="true">
    <app-add-action [hidden]="panelType" (onClose)="closeAddAction()" #addPanel></app-add-action>
  </mat-drawer>
</mat-drawer-container>

<mat-drawer-container [hasBackdrop]="true" [class]="'automation'">
  <mat-drawer #editDrawer position="end" [disableClose]="true">
    <app-edit-action [hidden]="panelType" (onClose)="closeEditAction()" #editPanel></app-edit-action>
  </mat-drawer>
</mat-drawer-container>
